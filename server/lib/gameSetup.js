// lib/gameSetup.js
const crypto = require('crypto');

function setupGame(players, selection, fairness = {}) {
  const { lastImpostorId = null, lastImpostorStreak = 0 } = fairness;
  const DEBUG = true;
  const log = (...a) => { if (DEBUG) console.log('[setupGame]', ...a); };

  // ===== 1) Normaliza entrada (string u objeto)
  const normalize = (sel) => {
    if (typeof sel === 'string') {
      if (sel.startsWith('F√∫tbol::')) {
        return { category: 'F√∫tbol', subtopic: sel.split('::')[1] || '' };
      }
      return { category: sel };
    }
    return sel || { category: 'animales' };
  };

  const sel = normalize(selection);
  log('input selection:', selection);
  log('normalized sel:', sel);

  // ===== 2) Pools base
  const BASE = {
    animales: ["perro","gato","elefante","le√≥n","tigre","oso","conejo","p√°jaro","pez","caballo","serpiente","pato","cocodrilo","jirafa","cebra","hipop√≥tamo","rinoceronte","mono","lobo","zorro","ciervo","ardilla","rat√≥n","murci√©lago","delf√≠n","ballena","foca","koala","canguro","panda","√°guila","b√∫ho","ping√ºino","flamenco","loro","cisne","gallina","gallo","pavo","tortuga","iguana","lagarto","camale√≥n","rana","sapo","salamandra","tibur√≥n","pulpo","medusa","estrella de mar","cangrejo","abeja","mariposa","hormiga","ara√±a","lib√©lula","escarabajo"],
    pel√≠culas: ['avatar','titanic','avengers','starwars','batman','superman','spiderman','frozen','shrek','harry potter','el se√±or de los anillos','jurassic park','jurassic world','el rey le√≥n','la bella y la bestia','los incre√≠bles','buscando a nemo','coco','mi villano favorito','minions','madagascar','kung fu panda','cars','intensamente','moana','encanto','doctor strange','iron man','thor','black panther','toy story','Interstellar','Joker','Deadpool','Barbie','Forrest gump','Matrix','El lobo de wall street','Up','Ratatouille','Wall-e','Monsters inc','Aladdin','Piratas del caribe','R√°pido y Furioso','Transformers','Maze runner','the silence of the lambs','the social network','a star is born','bohemian rhapsody','once upon a time in hollywood',"Guardianes de la Galaxia",'captain america','ant-man','black widow','john wick','mission: impossible','godzilla','breaking bad','game of thrones','stranger things','dark','the office','friends','black mirror','peaky blinders','narcos','la casa de papel','√©lite','vis a vis','chernobyl','lost','prison break','vikings',"grey's anatomy",'dragon ball z','el marginal','okupas','merl√≠'],
    cantantes: [
      "Bad Bunny","Daddy Yankee","Don Omar","Wisin","Yandel","Rauw Alejandro","Ozuna","Anuel AA","Tego Calder√≥n","Residente","Luis Fonsi","Ricky Martin","Chayanne","Pedro Cap√≥","Nicky Jam","Farruko","De La Ghetto","√ëengo Flow","Arc√°ngel","Zion","Lennox","Plan b",
      "Lunay","Myke Towers","Mora","Lyanno","Bryant Myers","Alex Rose","Dalex","Jay Wheeler","Almighty","Cosculluela",
      "Jowell y Randy","Kendo Kaponi","Anonimus","Young Miko","Villano Antillano","YOVNGCHIMI","De la Rose",
      "TINI","Mar√≠a Becerra","Lali","Emilia Mernes","Nicki Nicole","Cazzu","Nathy Peluso","Soledad Pastorutti",
      "Abel Pintos","Luciano Pereyra","Sergio Denis","Axel","Diego Torres","Fito P√°ez","Charly Garc√≠a","Gustavo Cerati",
      "Luis Alberto Spinetta","Andr√©s Calamaro","Vicentico","Paulo Londra","Duki","Bizarrap","Trueno",
      "Tiago PZK","Khea","Lit Killah","Rusherking","Wos","La Joaqui","Milo J","Luck Ra","BM","FMK",
      "Callejero Fino","Emanero","Pablo Lescano","Rodrigo","La Mona Jim√©nez","Ulises Bueno",
      "Miranda","Soda Stereo","Patricio Rey y sus Redonditos de Ricota","Los Fabulosos Cadillacs","Divididos","Las Pelotas","La Renga",
      "Los Piojos","Babas√≥nicos","Bersuit Vergarabat","Ratones Paranoicos","Enanitos Verdes","Attaque 77","2 Minutos","Rata Blanca",
      "Almafuerte","Pappo's Blues","Pescado Rabioso","Sui Generis","Ser√∫ Gir√°n","Virus","Turf","Los Tipitos","Los Brujos",
      "Los Pericos","Los Aut√©nticos Decadentes","Estelares","Guasones","Los Gardelitos","Viejas Locas","Intoxicados","Airbag",
      "Ciro y los Persas","La Beriso","Las Pastillas del Abuelo","Tan Bi√≥nica","El Mat√≥ a un Polic√≠a Motorizado",
      "Polim√° Westcoast","Pablo Chill-E","Cris MJ","Canserbero",
      "Shakira","Karol G","Maluma","J Balvin","Feid","Sebasti√°n Yatra","Camilo","Manuel Turizo",
      "Carlos Vives","Blessd","Ryan Castro","Be√©le","Morat","Ricardo Montaner","Ovy on the Drums",
      "Luis Miguel","Cristian Castro","Peso Pluma","Natanael Cano","Reik ","Man√° (Fher Olvera)","Sin Bandera (Noel Schajris)",
      "Romeo Santos","Prince Royce","Natti Natasha","Tokischa","El Alfa","Zion & Lennox",
      "Natalia Oreiro","Emiliano Brancciari (NTVG)","Sebasti√°n Teysera (La Vela Puerca)",
      "Roberto Musso (El Cuarteto de Nos)","Agust√≠n Casanova (M√°rama)","Fernando V√°zquez (Rombai)","Franny Glass",
      "Ricardo Montaner","Chino & Nacho","Danny Ocean",
      "Rosal√≠a","C. Tangana","Aitana","Quevedo","Lola √çndigo","Rels B","Bad Gyal","David Bisbal","Alejandro Sanz","Beret",
      "Leiva","Enrique Iglesias","Julio Iglesias","Omar Montes",
      "Sech","Boza","Joey Montana",
      "Camila Cabello"
    ],
  };

  // ===== 3) F√∫tbol + aliases + "Jugadores (todos)"
  const FUTBOL = {
    "üåç Jugadores actuales (mundo)": [
      'Vin√≠cius J√∫nior','Jude Bellingham','Rodrygo Goes','Thibaut Courtois','Fede Valverde','Aur√©lien Tchouam√©ni','√âder Milit√£o','Eduardo Camavinga','Toni Kroos','Luka Modriƒá','Franco Mastantuono','Robert Lewandowski','Lamine Yamal','Antoine Griezmann','Jan Oblak','Jo√£o F√©lix','Raphinha','Ronald Ara√∫jo','Frenkie de Jong','Pedri','Gavi','√Ålvaro Morata','Koke','I√±aki Williams','Erling Haaland','Kevin De Bruyne','Rodri','Phil Foden','Juli√°n √Ålvarez','Bernardo Silva','R√∫ben Dias',
      'Jack Grealish','Mohamed Salah','Virgil van Dijk','Alisson Becker','Trent Alexander-Arnold','Luis D√≠az','Bukayo Saka','Martin √òdegaard','Declan Rice','William Saliba','Gabriel Martinelli','Cole Palmer','Enzo Fern√°ndez','Mois√©s Caicedo','Bruno Fernandes','Marcus Rashford','Harry Kane','Jamal Musiala','Joshua Kimmich','Manuel Neuer','Thomas M√ºller','Matthijs de Ligt','Jadon Sancho','Julian Brandt','Florian Wirtz','Exequiel Palacios','Lautaro Mart√≠nez',
      'Dibu Mart√≠nez','Nicol√≤ Barella','Federico Dimarco','Federico Chiesa','Adrien Rabiot','Rafael Le√£o','Theo Hern√°ndez','Khvicha Kvaratskhelia','Victor Osimhen','Kylian Mbapp√©','Ousmane Demb√©l√©','Marquinhos','Achraf Hakimi','Roberto Firmino','Marcelo','Gianluigi Donnarumma','Vitinha','Cristiano Ronaldo','Neymar Jr.','Karim Benzema','Sadio Man√©',"N'Golo Kant√©",'Kalidou Koulibaly','Lionel Messi','Luis Su√°rez','Sergio Busquets','Jordi Alba','Lorenzo Insigne','Mauro Icardi','Romelu Lukaku',
      'Alejandro Garnacho',"Pierre-Emerick Aubameyang","Alexis S√°nchez","Arturo Vidal"
    ],

    "‚≠ê Leyendas": [
      "Diego Maradona","Pel√©","Johan Cruyff","Roberto Baggio","David Beckham",
      "Franz Beckenbauer","Alfredo Di St√©fano","Gerd M√ºller","Michel Platini",
      "Zinedine Zidane","Ronaldo Naz√°rio","Thierry Henry","Ronaldinho","Paolo Maldini",
      "Eric Cantona","Gianluigi Buffon","Giorgio Chiellini","Andr√©s Iniesta",
      "Xavi Hern√°ndez","Sergio Ramos","Andrea Pirlo","Francesco Totti",
      "Kak√°","Samuel Eto'o","Didier Drogba","Frank Lampard","Steven Gerrard",
      "Philipp Lahm","Arjen Robben","Wesley Sneijder","Wayne Rooney",
      "Bastian Schweinsteiger","Iker Casillas","Carles Puyol","Fabio Cannavaro",
      "Alessandro Nesta","Roberto Carlos","Caf√∫","Javier Zanetti","Gerard Piqu√©",
      "Marcelo","Oliver Kahn","Edwin van der Sar","Peter Schmeichel","Juan Sebasti√°n Ver√≥n",
      "Alessandro Del Piero","Pep Guardiola","Sergio Ag√ºero","Gareth Bale","Eden Hazard","Paulo Dybala",
      "Radamel Falcao","James Rodr√≠guez","Zlatan Ibrahimoviƒá","Petr ƒåech","Hugo Lloris","Keylor Navas",
      "Dani Alves","Thiago Silva","Pepe","David Villa","Fernando Torres","Xabi Alonso","Cesc F√†bregas","David Silva",
      "Patrick Vieira","David Trezeguet","Franck Rib√©ry","Lu√≠s Figo","Lev Yashin","Eus√©bio","Bobby Charlton","Michael Owen",
      "Rio Ferdinand","Ashley Cole","Lothar Matth√§us","Miroslav Klose","Michael Ballack","Marco van Basten","Ruud Gullit",
      "Rom√°rio","Rivaldo","S√≥crates","Gabriel Batistuta","Hern√°n Crespo","Juan Rom√°n Riquelme","Carlos Tevez","Ariel Ortega",
      "Fernando Redondo","Daniel Passarella","Mario Kempes","√ìscar Ruggeri","Enzo Francescoli","Diego Forl√°n",
      "Carlos Valderrama","Ren√© Higuita","Jos√© Luis Chilavert","Yaya Tour√©"
    ],

    "üá¶üá∑ Liga Argentina (actuales)": [
      "Leandro Paredes","Edinson Cavani","Kevin Zen√≥n","Alan Velasco","Miguel Merentiel","Luis Adv√≠ncula","Agust√≠n Marches√≠n","Sergio Romero","Frank Fabra","Ander Herrera","Cristian Lema",
      "Gonzalo Montiel","Lucas Mart√≠nez Quarta","Germ√°n Pezzella","Marcos Acu√±a","Paulo D√≠az","Sebasti√°n Driussi","Facundo Colidio","Juan Fernando Quintero","Gonzalo Mart√≠nez","Jerem√≠as Ledesma","Ignacio Fern√°ndez","Miguel Borja","Enzo P√©rez","Franco Armani",
      "Gabriel Arias","Mat√≠as Zaracho","Gast√≥n Martirena","Adri√°n Maravilla Mart√≠nez","Agust√≠n Almendra","Marcos Rojo",
      "Kevin Lom√≥naco","Felipe Loyola","Leonardo Godoy",
      "Cristian Medina","Fernando Muslera","Lucas Alario","Guido Carrillo","Santiago Ascac√≠bar","Edwuin Cetr√©","Facundo Far√≠as","Ramiro Funes Mori","Gonz√°lez P√≠rez","Jos√© Sosa",
      "Iker Muniain","√Ångel Di Mar√≠a","Ignacio Malcorra","Jorge Broun","Federico Girotti"
    ],

    // üèüÔ∏è Equipos (lista √∫nica como quer√≠as)
    "üèüÔ∏è Equipos": [
      "Boca Juniors","River Plate","Independiente","Racing Club","Estudiantes de La Plata","San Lorenzo",
      "V√©lez Sarsfield","Rosario Central","Newell's Old Boys","Gimnasia y Esgrima La Plata","Talleres de C√≥rdoba","Argentinos Juniors",
      "Lan√∫s","Hurac√°n","Defensa y Justicia","Godoy Cruz","Barracas","Platense",
      "Real Madrid","FC Barcelona","Atl√©tico de Madrid","Sevilla FC","Valencia CF","Villarreal CF","Real Sociedad","Athletic Club","Real Betis","Girona FC",
      "Manchester City","Arsenal FC","Liverpool FC","Manchester United","Chelsea FC","Tottenham Hotspur","Newcastle United","Aston Villa FC","West Ham United","Everton FC","Leicester City","Brighton",
      "Bayern M√∫nich","Borussia Dortmund","Bayer Leverkusen","RB Leipzig",
      "Inter","AC Milan","Juventus","AS Roma","SSC Napoli","Lazio",
      "PSG","Olympique de Marsella","Olympique de Lyon","AS Monaco","LOSC Lille","Stade Rennais FC","OGC Nice","RC Lens","FC Nantes",
      "SL Benfica","FC Porto","Sporting CP","Ajax","Inter Miami CF",
      "Flamengo","Palmeiras","Corinthians","S√£o Paulo FC","Santos FC","Gr√™mio","Internacional","Fluminense","Atl√©tico Mineiro","Botafogo","Athletico Paranaense","Fortaleza",
      "Nacional","Pe√±arol","Colo-Colo","Universidad de Chile","Universidad Cat√≥lica","LDU Quito","Barcelona SC","Independiente del Valle",
      "Atl√©tico Nacional","Millonarios FC","Am√©rica de Cali","Junior FC","Olimpia","Cerro Porte√±o","Libertad","Alianza Lima","Universitario"
    ],
  };

  // Aliases de compatibilidad
  FUTBOL["‚≠ê Leyendas (retirados)"]       = FUTBOL["‚≠ê Leyendas"];
  FUTBOL["üèüÔ∏è Equipos (Argentina)"]       = FUTBOL["üèüÔ∏è Equipos"];
  FUTBOL["üèüÔ∏è Equipos (Internacionales)"] = FUTBOL["üèüÔ∏è Equipos"];

  // üë• Jugadores (todos) = actuales + liga arg + leyendas (sin duplicados)
  const ALL_PLAYERS = [
    ...FUTBOL["üåç Jugadores actuales (mundo)"],
    ...FUTBOL["üá¶üá∑ Liga Argentina (actuales)"],
    ...FUTBOL["‚≠ê Leyendas"],
  ];
  const ALL_PLAYERS_UNIQUE = Array.from(new Set(ALL_PLAYERS));
  FUTBOL["üë• Jugadores (todos)"] = ALL_PLAYERS_UNIQUE;
  FUTBOL["Jugadores (todos)"]    = FUTBOL["üë• Jugadores (todos)"];
  FUTBOL["Todos los jugadores"]   = FUTBOL["üë• Jugadores (todos)"];

  // ===== 4) Normalizador robusto de subtema
  const FUT_KEYS = Object.keys(FUTBOL);
  const pickKey = (pred) => FUT_KEYS.find(k => pred(k.toLowerCase()));

  const normalizeSubtopic = (s = '') => {
    const t = String(s).toLowerCase().trim();

    // üë• Jugadores (todos) ‚Üí prioridad
    if (t.includes('jugad') && (t.includes('todos') || t.includes('todo'))) {
      return pickKey(k => k.includes('jugadores') && k.includes('todos')) || "üë• Jugadores (todos)";
    }

    // ‚≠ê Leyendas
    if (t.includes('leyend')) {
      return pickKey(k => k.includes('leyend')) || "‚≠ê Leyendas";
    }

    // üåç Jugadores actuales
    if (t.includes('jugad') && t.includes('actual')) {
      return pickKey(k => k.includes('jugadores') && k.includes('actual')) || FUT_KEYS[0];
    }

    // üá¶üá∑ Liga Argentina
    if (t.includes('liga') && t.includes('arg')) {
      return pickKey(k => k.includes('liga') && k.includes('arg')) || FUT_KEYS[0];
    }

    // üèüÔ∏è Equipos (lista √∫nica)
    if (t.includes('equip')) {
      return pickKey(k => k.includes('equip')) || "üèüÔ∏è Equipos";
    }

    // Si vino exacta
    if (FUTBOL[s]) return s;

    // Fallback dentro de F√∫tbol
    return "‚≠ê Leyendas";
  };

  // ===== 5) Elegir pool
  let pool = [];
  let resolvedSubKey = null;
  if (sel.category === 'F√∫tbol') {
    resolvedSubKey = normalizeSubtopic(sel.subtopic);
    log('resolved subKey:', resolvedSubKey);
    pool = FUTBOL[resolvedSubKey] || FUTBOL["‚≠ê Leyendas"];
  } else {
    pool = BASE[sel.category] || BASE.animales;
  }

  if (!Array.isArray(pool) || pool.length === 0) {
    log('WARN: pool vac√≠o, usando animales como √∫ltimo recurso');
    pool = BASE.animales;
  }

  // ===== 6) RNG robusto + evitar repetir impostor
  const rand = (max) => crypto.randomInt(0, max); // [0, max)

  const word = pool[rand(pool.length)];
  const n = players.length;

  let impostorIndex = rand(n);
  if (lastImpostorId && n > 1) {
    let tries = 5;
    while (tries-- > 0 && players[impostorIndex].id === lastImpostorId) {
      impostorIndex = rand(n);
    }
    if (players[impostorIndex].id === lastImpostorId) {
      // fuerza cambio si no hubo suerte aleatoria
      impostorIndex = (impostorIndex + 1) % n;
    }
  }
  const impostorId = players[impostorIndex].id;

  log('picked word:', word, '| subKey:', resolvedSubKey, '| impostorIndex:', impostorIndex);
  return { players, word, impostorId, impostorIndex, currentPlayerIndex: 0, subtopic: resolvedSubKey };
}

module.exports = { setupGame };
